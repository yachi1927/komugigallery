<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link href="style.css" rel="stylesheet" type="text/css" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Zen+Kaku+Gothic+New:wght@300&display=swap"
      rel="stylesheet"
    />
    <link
      rel="shortcut icon"
      href="https://lh3.googleusercontent.com/pw/AP1GczPcJnyP0x_e-ArxvuH50PLBFqGn4dq7pzgJfQN0_cF0OxTV7zMig3DPR8dH5ccuGHR2bITDWkDXbW6BYiMV5s87goBdnS2bXSqx7ALgkwtD-f46vx9tOGUBEGpTKfPacQvSBc9OCO3yWIsiINsMidMbFA=w512-h512-s-no-gm?authuser=0"
    />
    <title>Gallery</title>
  </head>
  <body>
    <div class="bg">
      <header>
        <a class="link" href="index.html">Top</a>

        <a class="link" href="upload.html">Upload</a>

        <a class="link" href="gallery.html">Gallery</a>

        <a class="link" href="tags.html">Tag</a>
      </header>

      <div id="gallery"></div>
      <div id="pagination"></div>

      <div class="modal" id="modal">
        <div class="modal-content" id="modalContent"></div>
        <button class="close-btn" id="closeBtn">Close</button>
      </div>
    </div>

    <script>
      // 選択中のタグ配列
      let selectedTags = [];

      // 現在ページ番号
      let currentPage = 1;
      let totalPages = 1;

      // タグ一覧取得して表示（クリックで選択切り替え）
      async function loadTags() {
        try {
          const res = await fetch("/tags");
          if (!res.ok) throw new Error("タグ取得失敗");
          const tags = await res.json();

          const container = document.getElementById("tags-container");
          container.innerHTML = "";

          tags.forEach((tag) => {
            const tagEl = document.createElement("button");
            tagEl.textContent = tag;
            tagEl.className = "tag-btn";
            tagEl.style.margin = "4px";
            tagEl.style.padding = "4px 8px";
            tagEl.style.border = "1px solid #ccc";
            tagEl.style.cursor = "pointer";

            tagEl.addEventListener("click", () => {
              toggleTag(tag);
            });

            container.appendChild(tagEl);
          });

          updateTagButtons();
        } catch (e) {
          alert(e.message);
        }
      }

      // タグ選択切り替え
      function toggleTag(tag) {
        const idx = selectedTags.indexOf(tag);
        if (idx >= 0) {
          selectedTags.splice(idx, 1);
        } else {
          selectedTags.push(tag);
        }
        currentPage = 1; // タグ切り替え時は1ページ目に戻る
        updateTagButtons();
        loadGallery(currentPage);
      }

      // タグボタンの選択状態を更新
      function updateTagButtons() {
        const buttons = document.querySelectorAll("#tags-container .tag-btn");
        buttons.forEach((btn) => {
          if (selectedTags.includes(btn.textContent)) {
            btn.style.backgroundColor = "#007bff";
            btn.style.color = "white";
          } else {
            btn.style.backgroundColor = "";
            btn.style.color = "";
          }
        });
      }

      // ギャラリー表示
      function displayImages(posts) {
        const container = document.getElementById("gallery");
        container.innerHTML = "";

        if (posts.length === 0) {
          container.textContent = "該当する画像がありません";
          return;
        }

        posts.forEach((post) => {
          const div = document.createElement("div");
          div.style.display = "inline-block";
          div.style.margin = "8px";
          div.style.border = "1px solid #ddd";
          div.style.padding = "4px";

          // 画像が複数あれば最初の1枚だけ表示（必要に応じて調整可）
          const img = document.createElement("img");
          img.src = post.imageUrls[0];
          img.style.width = "150px";
          img.style.height = "150px";
          img.style.objectFit = "cover";
          img.alt = post.tags.join(", ");

          div.appendChild(img);
          container.appendChild(div);
        });
      }

      // ページネーション表示・制御
      function renderPagination() {
        const container = document.getElementById("pagination");
        container.innerHTML = "";

        if (totalPages <= 1) return;

        // 「前」ボタン
        const prevBtn = document.createElement("button");
        prevBtn.textContent = "前";
        prevBtn.disabled = currentPage === 1;
        prevBtn.addEventListener("click", () => {
          if (currentPage > 1) {
            currentPage--;
            loadGallery(currentPage);
          }
        });
        container.appendChild(prevBtn);

        // ページ番号表示（例: 1 / 5）
        const pageInfo = document.createElement("span");
        pageInfo.textContent = ` ${currentPage} / ${totalPages} `;
        pageInfo.style.margin = "0 8px";
        container.appendChild(pageInfo);

        // 「次」ボタン
        const nextBtn = document.createElement("button");
        nextBtn.textContent = "次";
        nextBtn.disabled = currentPage === totalPages;
        nextBtn.addEventListener("click", () => {
          if (currentPage < totalPages) {
            currentPage++;
            loadGallery(currentPage);
          }
        });
        container.appendChild(nextBtn);
      }

      // ギャラリーの画像をAPIから取得して表示
      async function loadGallery(page = 1) {
        try {
          // タグをカンマ区切り文字列に
          const tagsParam = selectedTags.join(",");
          let url = `/gallery-data?page=${page}`;
          if (tagsParam) {
            url += `&tags=${encodeURIComponent(tagsParam)}`;
          }

          const res = await fetch(url);
          if (!res.ok) throw new Error("ギャラリー取得失敗");

          const json = await res.json();

          displayImages(json.posts);
          currentPage = json.currentPage;
          totalPages = json.totalPages;

          renderPagination();
        } catch (e) {
          alert(e.message);
        }
      }

      // 初期処理
      window.onload = () => {
        loadTags();
        loadGallery();
      };
    </script>
  </body>
</html>
