<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link href="style.css" rel="stylesheet" type="text/css" />
    <title>Gallery</title>
  </head>

  <body>
    <div class="bg">
      <header>
        <a class="link" href="index.html">Top</a>
        <a class="link" href="upload.html">Upload</a>
        <a class="link" href="gallery.html">Gallery</a>
        <a class="link" href="tags.html">Tag</a>
      </header>

      <div id="tags-container"></div>
      <div id="gallery"></div>
      <div id="pagination"></div>
    </div>

    <script>
      let selectedTag = null;
      let currentPage = 1;
      let totalPages = 1;

      // タグ取得してボタン表示
      async function loadTags() {
        try {
          const res = await fetch("/tags");
          if (!res.ok) throw new Error("タグの取得に失敗しました");
          const tags = await res.json();

          const container = document.getElementById("tags-container");
          container.innerHTML = "";

          tags.forEach((tag) => {
            const btn = document.createElement("button");
            btn.className = "tag-btn";
            btn.textContent = tag;
            btn.addEventListener("click", () => {
              // 同じタグが選択されていれば解除、違えば選択し直し
              selectedTag = selectedTag === tag ? null : tag;
              currentPage = 1;
              updateTagButtons();
              loadGallery(currentPage);
            });
            container.appendChild(btn);
          });

          updateTagButtons();
        } catch (e) {
          alert(e.message);
        }
      }

      // 選択タグのボタン状態を更新
      function updateTagButtons() {
        const buttons = document.querySelectorAll(".tag-btn");
        buttons.forEach((btn) => {
          if (btn.textContent === selectedTag) {
            btn.classList.add("selected");
          } else {
            btn.classList.remove("selected");
          }
        });
      }

      // 画像をカード形式で表示
      function displayImages(posts) {
        const gallery = document.getElementById("gallery");
        gallery.innerHTML = "";

        if (posts.length === 0) {
          gallery.textContent = "該当する画像がありません";
          return;
        }

        posts.forEach((post) => {
          const card = document.createElement("div");
          card.className = "image-card";

          const img = document.createElement("img");
          img.src = post.imageUrls[0];
          img.alt = post.tags.join(", ");

          card.appendChild(img);
          gallery.appendChild(card);
        });
      }

      // ページネーションの描画
      function renderPagination() {
        const container = document.getElementById("pagination");
        container.innerHTML = "";

        if (totalPages <= 1) return;

        const prevBtn = document.createElement("button");
        prevBtn.textContent = "前";
        prevBtn.disabled = currentPage === 1;
        prevBtn.onclick = () => {
          if (currentPage > 1) {
            currentPage--;
            loadGallery(currentPage);
          }
        };
        container.appendChild(prevBtn);

        const info = document.createElement("span");
        info.textContent = ` ${currentPage} / ${totalPages} `;
        container.appendChild(info);

        const nextBtn = document.createElement("button");
        nextBtn.textContent = "次";
        nextBtn.disabled = currentPage === totalPages;
        nextBtn.onclick = () => {
          if (currentPage < totalPages) {
            currentPage++;
            loadGallery(currentPage);
          }
        };
        container.appendChild(nextBtn);
      }

      // ギャラリー読み込み（タグ1つだけ送る）
      async function loadGallery(page = 1) {
        try {
          let url = `/gallery-data?page=${page}`;
          if (selectedTag) {
            url += `&tag=${encodeURIComponent(selectedTag)}`;
          }
          const res = await fetch(url);
          if (!res.ok) throw new Error("ギャラリーの取得に失敗しました");
          const json = await res.json();

          displayImages(json.posts);
          currentPage = json.currentPage;
          totalPages = json.totalPages;
          renderPagination();
        } catch (e) {
          alert(e.message);
        }
      }

      window.onload = () => {
        loadTags();
        loadGallery();
      };
    </script>
  </body>
</html>
