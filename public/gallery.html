<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link href="style.css" rel="stylesheet" type="text/css" />
    <link
      rel="shortcut icon"
      href="https://lh3.googleusercontent.com/pw/AP1GczPcJnyP0x_e-ArxvuH50PLBFqGn4dq7pzgJfQN0_cF0OxTV7zMig3DPR8dH5ccuGHR2bITDWkDXbW6BYiMV5s87goBdnS2bXSqx7ALgkwtD-f46vx9tOGUBEGpTKfPacQvSBc9OCO3yWIsiINsMidMbFA=w512-h512-s-no-gm?authuser=0"
    />
    <title>Gallery</title>
  </head>

  <body>
    <div class="bg">
      <header>
        <a class="link" href="index.html">Top</a>
        <a class="link" href="upload.html">Upload</a>
        <a class="link" href="gallery.html">Gallery</a>
        <a class="link" href="tags.html">Tag</a>
      </header>

      <button id="toggleTagsBtn">Open</button>
      <div id="tags-container" class="hidden"></div>
      <div id="gallery"></div>
      <div id="pagination"></div>

      <div id="modal" class="modal">
        <button id="modalClose" class="close-btn">Close</button>
        <div class="carousel-container">
          <button id="prevBtn" class="close-btn" style="margin-right: 10px">
            ←
          </button>
          <div id="carousel" class="carousel"></div>
          <button id="nextBtn" class="close-btn" style="margin-left: 10px">
            →
          </button>
        </div>
      </div>

      <div id="tagEditorModal" class="modal">
        <div class="modal-content">
          <h3>Edit</h3>
          <textarea id="tagEditorInput" rows="3" style="width: 100%"></textarea>
          <button id="tagEditorSaveBtn">Save</button>
          <button id="tagEditorCancelBtn">Cancel</button>
        </div>
      </div>
    </div>

    <script>
      let currentPage = 1;
      let totalPages = 1;
      let editingPost = null; // 編集対象の画像情報

      // ギャラリー画像データ取得API
      async function loadGallery(page = 1) {
        try {
          const res = await fetch(`/gallery-data?page=${page}`);
          if (!res.ok) throw new Error("ギャラリーの取得に失敗しました");
          const json = await res.json();

          displayImages(json.posts);
          currentPage = json.currentPage;
          totalPages = json.totalPages;
        } catch (e) {
          alert(e.message);
        }
      }

      // 画像カード生成と表示
      function displayImages(posts) {
        const gallery = document.getElementById("gallery");
        gallery.innerHTML = "";

        if (posts.length === 0) {
          gallery.textContent = "該当する画像がありません";
          return;
        }

        posts.forEach((post) => {
          const card = document.createElement("div");
          card.className = "image-card";
          card.style.border = "1px solid #ccc";
          card.style.margin = "10px";
          card.style.padding = "10px";
          card.style.position = "relative";
          card.style.display = "inline-block";

          const img = document.createElement("img");
          img.src = post.imageUrls[0];
          img.alt = post.tags.join(", ");
          img.style.width = "200px";
          img.style.height = "auto";
          card.appendChild(img);

          // メニューラッパー
          const menuWrapper = document.createElement("div");
          menuWrapper.className = "menu-wrapper";

          // ⋮ ボタン
          const menuBtn = document.createElement("button");
          menuBtn.className = "menu-btn";
          menuBtn.textContent = "︙";

          // メニュー本体
          const menuDropdown = document.createElement("div");
          menuDropdown.className = "menu-dropdown";
          menuDropdown.style.display = "none";

          // 削除ボタン
          const deleteOption = document.createElement("button");
          deleteOption.textContent = "削除";
          deleteOption.addEventListener("click", async (e) => {
            e.stopPropagation();
            if (!confirm("本当にこの画像を削除しますか？")) return;

            try {
              const res = await fetch("/delete-post", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ id: post.id }),
              });
              if (!res.ok) throw new Error(await res.text());
              alert("画像を削除しました");
              loadGallery(currentPage);
            } catch (err) {
              alert("削除に失敗しました: " + err.message);
            }
          });

          // タグ編集ボタン
          const editOption = document.createElement("button");
          editOption.textContent = "タグ編集";
          editOption.addEventListener("click", (e) => {
            e.stopPropagation();
            openTagEditor(post);
            menuDropdown.style.display = "none";
          });

          // メニューの開閉
          menuBtn.addEventListener("click", (e) => {
            e.stopPropagation();
            menuDropdown.style.display =
              menuDropdown.style.display === "none" ? "block" : "none";
          });

          // メニュー外クリックで閉じる
          document.addEventListener("click", (e) => {
            if (!menuWrapper.contains(e.target)) {
              menuDropdown.style.display = "none";
            }
          });

          menuDropdown.appendChild(editOption);
          menuDropdown.appendChild(deleteOption);
          menuWrapper.appendChild(menuBtn);
          menuWrapper.appendChild(menuDropdown);

          card.appendChild(menuWrapper);
          gallery.appendChild(card);
        });
      }

      // タグ編集モーダル要素
      const tagEditorModal = document.getElementById("tagEditorModal");
      const tagEditorInput = document.getElementById("tagEditorInput");
      const tagEditorSaveBtn = document.getElementById("tagEditorSaveBtn");
      const tagEditorCancelBtn = document.getElementById("tagEditorCancelBtn");

      // タグ編集モーダルを開く
      function openTagEditor(post) {
        editingPost = post;
        tagEditorInput.value = post.tags.join(", ");
        tagEditorModal.classList.add("active");
        tagEditorInput.focus();
      }

      // タグ編集モーダルを閉じる
      function closeTagEditor() {
        tagEditorModal.classList.remove("active");
        editingPost = null;
        tagEditorInput.value = "";
      }

      // タグ保存処理
      async function saveTags() {
        if (!editingPost) return;

        const newTags = tagEditorInput.value
          .split(",")
          .map((t) => t.trim())
          .filter((t) => t.length > 0);

        try {
          const res = await fetch("/update-tags", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              id: editingPost.id,
              tags: newTags, // 配列で送る場合はここでjoinしない
            }),
          });
          if (!res.ok) throw new Error(await res.text());

          editingPost.tags = newTags; // ローカルデータ更新
          alert("タグを更新しました: " + newTags.join(", "));
          closeTagEditor();
          loadGallery(currentPage);
        } catch (err) {
          alert("タグ更新に失敗しました: " + err.message);
        }
      }

      // イベントリスナーセットアップ
      tagEditorSaveBtn.addEventListener("click", saveTags);
      tagEditorCancelBtn.addEventListener("click", closeTagEditor);

      // モーダルの背景クリックで閉じる
      tagEditorModal.addEventListener("click", (e) => {
        if (e.target === tagEditorModal) closeTagEditor();
      });

      // ESCキーで閉じる
      window.addEventListener("keydown", (e) => {
        if (e.key === "Escape" && tagEditorModal.classList.contains("active")) {
          closeTagEditor();
        }
      });

      // 初期読み込み
      window.onload = () => {
        loadGallery(currentPage);
      };
    </script>
  </body>
</html>
