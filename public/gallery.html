<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link href="style.css" rel="stylesheet" type="text/css" />
    <link
      rel="shortcut icon"
      href="https://lh3.googleusercontent.com/pw/AP1GczPcJnyP0x_e-ArxvuH50PLBFqGn4dq7pzgJfQN0_cF0OxTV7zMig3DPR8dH5ccuGHR2bITDWkDXbW6BYiMV5s87goBdnS2bXSqx7ALgkwtD-f46vx9tOGUBEGpTKfPacQvSBc9OCO3yWIsiINsMidMbFA=w512-h512-s-no-gm?authuser=0"
    />
    <title>Gallery</title>
  </head>

  <body>
    <div class="bg">
      <header>
        <a class="link" href="index.html">Top</a>
        <a class="link" href="upload.html">Upload</a>
        <a class="link" href="gallery.html">Gallery</a>
        <a class="link" href="tags.html">Tag</a>
      </header>

      <button id="toggleTagsBtn">Open</button>
      <div id="tags-container" class="hidden"></div>
      <div id="gallery"></div>
      <div id="pagination"></div>

      <div id="modal" class="modal">
        <button id="modalClose" class="close-btn">Close</button>
        <div class="carousel-container">
          <button id="prevBtn" class="close-btn" style="margin-right: 10px">
            â†
          </button>
          <div id="carousel" class="carousel"></div>
          <button id="nextBtn" class="close-btn" style="margin-left: 10px">
            â†’
          </button>
        </div>
      </div>

      <div id="tagEditorModal" class="modal">
        <div class="modal-content">
          <h3>Edit</h3>
          <textarea id="tagEditorInput" rows="3" style="width: 100%"></textarea>
          <button id="tagEditorSaveBtn">Save</button>
          <button id="tagEditorCancelBtn">Cancel</button>
        </div>
      </div>
    </div>

    <script>
      let selectedTag = null;
      let currentPage = 1;
      let totalPages = 1;

      let modal = null;
      let carousel = null;
      let modalCloseBtn = null;
      let prevBtn = null;
      let nextBtn = null;
      let currentSlide = 0;
      let currentImages = [];

      // ç®¡ç†è€…åˆ¤å®šãƒ•ãƒ©ã‚°ï¼ˆé©å®œã‚»ãƒƒãƒˆã—ã¦ãã ã•ã„ï¼‰
      const isAdmin = true; // ã“ã“ã¯å®Ÿéš›ã®èªè¨¼çŠ¶æ…‹ã«åˆã‚ã›ã¦è¨­å®šã—ã¦ãã ã•ã„

      // --- ã‚¿ã‚°ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ç”¨è¦ç´  ---
      let tagEditorModal = null;
      let tagEditorInput = null;
      let tagEditorSaveBtn = null;
      let tagEditorCancelBtn = null;
      let editingPost = null; // ç¾åœ¨ç·¨é›†ä¸­ã®post

      // URLã‹ã‚‰tagãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’å–å¾—
      function getTagFromURL() {
        const params = new URLSearchParams(window.location.search);
        return params.get("tag");
      }

      // URLã‹ã‚‰pageãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’å–å¾—
      function getPageFromURL() {
        const params = new URLSearchParams(window.location.search);
        const p = parseInt(params.get("page"), 10);
        return isNaN(p) || p < 1 ? 1 : p;
      }

      // URLã®queryãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’æ›¸ãæ›ãˆï¼ˆå±¥æ­´ã«è¿½åŠ ï¼‰
      function updateURL() {
        const params = new URLSearchParams();
        if (selectedTag) params.set("tag", selectedTag);
        if (currentPage > 1) params.set("page", currentPage);
        const newUrl =
          window.location.pathname +
          (params.toString() ? `?${params.toString()}` : "");
        history.pushState(null, "", newUrl);
      }

      // ã‚¿ã‚°å–å¾—ã—ã¦ãƒœã‚¿ãƒ³è¡¨ç¤º
      async function loadTags() {
        try {
          const res = await fetch("/tags");
          if (!res.ok) throw new Error("ã‚¿ã‚°ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ");
          const tags = await res.json();

          const container = document.getElementById("tags-container");
          container.innerHTML = "";

          tags.forEach((tag) => {
            const btn = document.createElement("button");
            btn.className = "tag-btn";
            btn.textContent = tag;
            btn.addEventListener("click", () => {
              selectedTag = selectedTag === tag ? null : tag;
              currentPage = 1;
              updateTagButtons();
              updateURL();
              loadGallery(currentPage);
            });
            container.appendChild(btn);
          });

          updateTagButtons();
        } catch (e) {
          alert(e.message);
        }
      }

      // é¸æŠã‚¿ã‚°ã®ãƒœã‚¿ãƒ³çŠ¶æ…‹ã‚’æ›´æ–°
      function updateTagButtons() {
        const buttons = document.querySelectorAll(".tag-btn");
        buttons.forEach((btn) => {
          if (btn.textContent === selectedTag) {
            btn.classList.add("selected");
          } else {
            btn.classList.remove("selected");
          }
        });
      }

      // ç”»åƒã‚’ã‚«ãƒ¼ãƒ‰å½¢å¼ã§è¡¨ç¤ºã€ã‚¯ãƒªãƒƒã‚¯ã§ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
      function displayImages(posts) {
        console.log(posts);
        const gallery = document.getElementById("gallery");
        gallery.innerHTML = "";

        if (posts.length === 0) {
          gallery.textContent = "è©²å½“ã™ã‚‹ç”»åƒãŒã‚ã‚Šã¾ã›ã‚“";
          return;
        }

        posts.forEach((post) => {
          const card = document.createElement("div");
          card.className = "image-card";

          const img = document.createElement("img");
          img.src = post.imageUrls[0];
          img.alt = post.tags.join(", ");

          img.addEventListener("click", () => {
            openModal(post.imageUrls);
          });

          // 3ç‚¹ãƒªãƒ¼ãƒ€ãƒ¼ãƒœã‚¿ãƒ³ï¼ˆã‚¿ã‚°ç·¨é›†ç”¨ï¼‰
          const menuBtn = document.createElement("button");
          menuBtn.className = "menu-btn";
          menuBtn.textContent = "ï¸™";
          menuBtn.addEventListener("click", (e) => {
            e.stopPropagation();
            openTagEditor(post);
          });

          // å‰Šé™¤ãƒœã‚¿ãƒ³ã‚’ä½œæˆï¼ˆç®¡ç†è€…ã®ã¿ï¼‰
          let deleteBtn = null;
          if (isAdmin) {
            deleteBtn = document.createElement("button");
            deleteBtn.className = "delete-btn";
            deleteBtn.textContent = "ğŸ—‘";

            deleteBtn.addEventListener("click", async (e) => {
              e.stopPropagation();

              if (!post.id) {
                alert("æŠ•ç¨¿IDãŒä¸æ­£ã§ã™");
                return;
              }

              if (confirm("ã“ã®æŠ•ç¨¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) {
                try {
                  const token = localStorage.getItem("token");
                  if (!token) {
                    alert("ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™");
                    return;
                  }

                  const res = await fetch(`/posts/${post.id}`, {
                    method: "DELETE",
                    headers: {
                      Authorization: `Bearer ${token}`,
                    },
                  });

                  const data = await res.json();

                  if (!res.ok) {
                    throw new Error(data.error || "å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ");
                  }

                  alert(data.message || "å‰Šé™¤ã—ã¾ã—ãŸ");
                  await loadGallery(currentPage); // æœ€æ–°ã®ã‚®ãƒ£ãƒ©ãƒªãƒ¼ã‚’èª­ã¿ç›´ã™
                } catch (err) {
                  alert(err.message);
                }
              }
            });
          }

          // cardã«è¦ç´ ã‚’è¿½åŠ 
          card.appendChild(img);
          card.appendChild(menuBtn);
          if (deleteBtn) card.appendChild(deleteBtn);

          gallery.appendChild(card);
        });
      }

      // ãƒ¢ãƒ¼ãƒ€ãƒ«é–‹ãé–¢æ•°
      function openModal(images) {
        currentImages = images;
        currentSlide = 0;
        renderCarousel();
        modal.classList.add("active");
        updateNavButtons();
      }

      // ã‚«ãƒ«ãƒ¼ã‚»ãƒ«æç”»
      function renderCarousel() {
        const track = document.createElement("div");
        track.className = "carousel-track";

        currentImages.forEach((src) => {
          const img = document.createElement("img");
          img.src = src;
          track.appendChild(img);
        });

        track.style.transform = `translateX(-${currentSlide * 100}%)`;

        carousel.innerHTML = "";
        carousel.appendChild(track);
      }

      // ãƒŠãƒ“ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹æ›´æ–°
      function updateNavButtons() {
        if (currentImages.length <= 1) {
          prevBtn.style.display = "none";
          nextBtn.style.display = "none";
        } else {
          prevBtn.style.display = "inline-block";
          nextBtn.style.display = "inline-block";
        }
      }

      // ãƒŠãƒ“æ“ä½œ
      function showPrev() {
        if (currentSlide > 0) {
          currentSlide--;
          renderCarousel();
        }
      }
      function showNext() {
        if (currentSlide < currentImages.length - 1) {
          currentSlide++;
          renderCarousel();
        }
      }

      // ãƒ¢ãƒ¼ãƒ€ãƒ«é–‰ã˜ã‚‹
      function closeModal() {
        modal.classList.remove("active");
      }

      // ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ã®æç”»
      function renderPagination() {
        const container = document.getElementById("pagination");
        container.innerHTML = "";

        if (totalPages <= 1) return;

        const prevBtn = document.createElement("button");
        prevBtn.textContent = "Back";
        prevBtn.disabled = currentPage === 1;
        prevBtn.onclick = () => {
          if (currentPage > 1) {
            currentPage--;
            updateURL();
            loadGallery(currentPage);
          }
        };
        container.appendChild(prevBtn);

        const nextBtn = document.createElement("button");
        nextBtn.textContent = "Next";
        nextBtn.disabled = currentPage === totalPages;
        nextBtn.onclick = () => {
          if (currentPage < totalPages) {
            currentPage++;
            updateURL();
            loadGallery(currentPage);
          }
        };
        container.appendChild(nextBtn);
      }

      // ã‚®ãƒ£ãƒ©ãƒªãƒ¼èª­ã¿è¾¼ã¿ï¼ˆã‚¿ã‚°1ã¤ã ã‘é€ã‚‹ï¼‰
      async function loadGallery(page = 1) {
        try {
          let url = `/gallery-data?page=${page}`;
          if (selectedTag) {
            url += `&tag=${encodeURIComponent(selectedTag)}`;
          }
          const res = await fetch(url);
          if (!res.ok) throw new Error("ã‚®ãƒ£ãƒ©ãƒªãƒ¼ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ");
          const json = await res.json();

          displayImages(json.posts);
          currentPage = json.currentPage;
          totalPages = json.totalPages;
          renderPagination();
        } catch (e) {
          alert(e.message);
        }
      }

      // ------------- ã‚¿ã‚°ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ã®åˆ¶å¾¡ ---------------

      // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ãï¼ˆpostã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’æ¸¡ã™ï¼‰
      function openTagEditor(post) {
        editingPost = post;
        tagEditorInput.value = post.tags.join(", ");
        tagEditorModal.classList.add("active");
      }

      // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
      function closeTagEditor() {
        tagEditorModal.classList.remove("active");
        editingPost = null;
      }

      // ä¿å­˜ãƒœã‚¿ãƒ³ï¼ˆã‚¿ã‚°æ›´æ–°APIã‚’å‘¼ã¶ï¼‰
      async function saveTags() {
        if (!editingPost) return;

        const newTags = tagEditorInput.value
          .split(",")
          .map((t) => t.trim())
          .filter((t) => t.length > 0);

        try {
          const res = await fetch("/update-tags", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ id: editingPost.id, tags: newTags }),
          });

          const data = await res.json();

          if (!res.ok) {
            throw new Error(data.error || "ã‚¿ã‚°æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ");
          }

          alert("ã‚¿ã‚°ã‚’æ›´æ–°ã—ã¾ã—ãŸ: " + newTags.join(", "));
          closeTagEditor();
          await loadGallery(currentPage);
        } catch (error) {
          alert(error.message);
        }
      }

      window.onload = async () => {
        selectedTag = getTagFromURL();
        currentPage = getPageFromURL();
        await loadTags();
        updateTagButtons();
        await loadGallery(currentPage);

        modal = document.getElementById("modal");
        carousel = document.getElementById("carousel");
        modalCloseBtn = document.getElementById("modalClose");
        prevBtn = document.getElementById("prevBtn");
        nextBtn = document.getElementById("nextBtn");

        // ã‚¿ã‚°ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«è¦ç´ å–å¾—
        tagEditorModal = document.getElementById("tagEditorModal");
        tagEditorInput = document.getElementById("tagEditorInput");
        tagEditorSaveBtn = document.getElementById("tagEditorSaveBtn");
        tagEditorCancelBtn = document.getElementById("tagEditorCancelBtn");

        modalCloseBtn.addEventListener("click", closeModal);
        prevBtn.addEventListener("click", showPrev);
        nextBtn.addEventListener("click", showNext);

        tagEditorSaveBtn.addEventListener("click", saveTags);
        tagEditorCancelBtn.addEventListener("click", closeTagEditor);

        // ãƒ¢ãƒ¼ãƒ€ãƒ«å¤–ã‚¯ãƒªãƒƒã‚¯ã§ã‚¿ã‚°ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«é–‰ã˜ã‚‹
        tagEditorModal.addEventListener("click", (e) => {
          if (e.target === tagEditorModal) closeTagEditor();
        });

        window.addEventListener("keydown", (e) => {
          if (e.key === "Escape") {
            if (modal.classList.contains("active")) closeModal();
            if (tagEditorModal.classList.contains("active")) closeTagEditor();
          }
        });

        const toggleBtn = document.getElementById("toggleTagsBtn");
        const tagsContainer = document.getElementById("tags-container");

        toggleBtn.addEventListener("click", () => {
          tagsContainer.classList.toggle("hidden");
          toggleBtn.textContent = tagsContainer.classList.contains("hidden")
            ? "Open"
            : "Close";
        });
      };

      // ãƒ–ãƒ©ã‚¦ã‚¶ã®æˆ»ã‚‹ãƒ»é€²ã‚€ã«å¯¾å¿œ
      window.onpopstate = () => {
        selectedTag = getTagFromURL();
        currentPage = getPageFromURL();
        updateTagButtons();
        loadGallery(currentPage);
      };
    </script>
  </body>
</html>
